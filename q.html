// Replace the entire <script> section with this corrected version:

<script>
    const CONFIG = {
      supabase: {
        url: 'https://kplmeebifsuziytppwzb.supabase.co', 
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbG1lZWJpZnN1eml5dHBwd3piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2ODU1NTcsImV4cCI6MjA3ODI2MTU1N30.lzfjMdr5hD7FWcVu-0dHbj7ZgXrttlfxHsaO6_vyAHw',
        emailFunctionUrl: 'https://kplmeebifsuziytppwzb.supabase.co/functions/v1/clever-responder' 
      },
      razorpay: {
        key: 'rzp_test_1DP5mmOlF5G5ag'
      },
      store: {
        email: 'hello.mishajwellery@gmail.com',
        phone: '+917771818695'
      }
    };

    const supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);

    const app = {
      cart: JSON.parse(localStorage.getItem('cart')) || [],
      wishlist: JSON.parse(localStorage.getItem('wishlist')) || [],
      currentCategory: null,
      currentProduct: null,
      currentPage: 1,
      itemsPerPage: 10,
      productQuantity: 1,
      customerInfo: null,
      currentBannerIndex: 0,
      bannerInterval: null,
      totalBanners: 3,
      categories: [  
        { id: 'rings', name: 'Rings', image: 'https://images.unsplash.com/photo-1605100804763-247f67b3557e?auto=format&fit=crop&w=500&q=80', description: 'Elegant rings for every occasion', icon: 'fa-ring' },
        { id: 'necklaces', name: 'Necklaces', image: 'https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?auto=format&fit=crop&w=500&q=80', description: 'Beautiful necklaces and pendants', icon: 'fa-gem' },
        { id: 'earrings', name: 'Earrings', image: 'https://images.unsplash.com/photo-1611591437281-460cc5f3e1c7?auto=format&fit=crop&w=500&q=80', description: 'Stunning earrings collection', icon: 'fa-earring' },
        { id: 'bracelets', name: 'Bracelets', image: 'https://images.unsplash.com/photo-1618331835717-801e976710b8?auto=format&fit=crop&w=500&q=80', description: 'Charming bracelets and bangles', icon: 'fa-hand-sparkles' },
        { id: 'anklets', name: 'Anklets', image: 'https://images.unsplash.com/photo-1607082350899-7e105aa886ae?auto=format&fit=crop&w=500&q=80', description: 'Delicate anklets', icon: 'fa-ankh' }
      ],

      async init() {
        await this.loadProducts();
        this.renderCardSlider();
        this.renderCategorySidebar();
        this.renderProductSlider();
        this.updateCartCount();
        this.updateWishlistCount();
        this.setupEventListeners();
        this.setupSearch();
        this.initBannerCarousel();
      },

      async loadProducts() {
        try {
          const { data, error } = await supabase
            .from('products')
            .select('*')
            .eq('active', true);
          
          if (error) {
            console.error('Error loading products:', error);
            this.products = this.getSampleProducts();
          } else {
            this.products = data && data.length > 0 ? data : this.getSampleProducts();
          }
        } catch (err) {
          console.error('Failed to load products:', err);
          this.products = this.getSampleProducts();
        }
      },

      getSampleProducts() {
        return [
          {
            id: 'ring-1',
            name: 'Diamond Solitaire Ring',
            category: 'rings',
            price: 5999,
            description: 'Elegant solitaire ring with cubic zirconia stone. Perfect for engagements or special occasions.',
            images: ['https://images.unsplash.com/photo-1605100804763-247f67b3557e?auto=format&fit=crop&w=600'],
            active: true
          },
          {
            id: 'necklace-1',
            name: 'Heritage Necklace',
            category: 'necklaces',
            price: 4800,
            description: 'Timeless design with intricate detailing inspired by traditional Indian craftsmanship.',
            images: ['https://images.unsplash.com/photo-1599508080112-e8e3de2908c1?auto=format&fit=crop&w=600'],
            active: true
          },
          {
            id: 'earring-1',
            name: 'Jhumka Earrings',
            category: 'earrings',
            price: 1950,
            description: 'Traditional jhumkas with modern flair. Lightweight and comfortable for all-day wear.',
            images: ['https://images.unsplash.com/photo-1618312900238-2f3a4e5e3e1d?auto=format&fit=crop&w=600'],
            active: true
          },
          {
            id: 'bracelet-1',
            name: 'Temple Bracelet',
            category: 'bracelets',
            price: 3200,
            description: 'Inspired by South Indian temple architecture. A statement piece for any outfit.',
            images: ['https://images.unsplash.com/photo-1580805026712-2920a23d2e33?auto=format&fit=crop&w=600'],
            active: true
          },
          {
            id: 'anklet-1',
            name: 'Lotus Anklet',
            category: 'anklets',
            price: 2450,
            description: 'Handcrafted with delicate lotus motifs. Elegant and comfortable.',
            images: ['https://images.unsplash.com/photo-1607082350899-7e105aa886ae?auto=format&fit=crop&w=600'],
            active: true
          },
          {
            id: 'ring-2',
            name: 'Floral Band Ring',
            category: 'rings',
            price: 3499,
            description: 'Delicate floral pattern band ring. Perfect for daily wear.',
            images: ['https://images.unsplash.com/photo-1605100804763-247f67b3557e?auto=format&fit=crop&w=600'],
            active: true
          },
          {
            id: 'necklace-2',
            name: 'Pearl Pendant',
            category: 'necklaces',
            price: 2999,
            description: 'Elegant pearl pendant on sterling silver chain.',
            images: ['https://images.unsplash.com/photo-1599508080112-e8e3de2908c1?auto=format&fit=crop&w=600'],
            active: true
          }
        ];
      },

      // Banner functions
      initBannerCarousel() {
        const dotsContainer = document.getElementById('bannerDots');
        dotsContainer.innerHTML = '';
        
        for (let i = 0; i < this.totalBanners; i++) {
          const dot = document.createElement('div');
          dot.className = `banner-dot ${i === 0 ? 'active' : ''}`;
          dot.onclick = () => this.goToBanner(i);
          dotsContainer.appendChild(dot);
        }
        
        this.startBannerAutoPlay();
      },

      goToBanner(index) {
        this.currentBannerIndex = index;
        this.updateBannerPosition();
        this.stopBannerAutoPlay();
        this.startBannerAutoPlay();
      },

      nextBanner() {
        this.currentBannerIndex = (this.currentBannerIndex + 1) % this.totalBanners;
        this.updateBannerPosition();
        this.stopBannerAutoPlay();
        this.startBannerAutoPlay();
      },

      prevBanner() {
        this.currentBannerIndex = (this.currentBannerIndex - 1 + this.totalBanners) % this.totalBanners;
        this.updateBannerPosition();
        this.stopBannerAutoPlay();
        this.startBannerAutoPlay();
      },

      updateBannerPosition() {
        const slides = document.getElementById('bannerSlides');
        slides.style.transform = `translateX(-${this.currentBannerIndex * 100}%)`;
        
        document.querySelectorAll('.banner-dot').forEach((dot, index) => {
          dot.classList.toggle('active', index === this.currentBannerIndex);
        });
      },

      startBannerAutoPlay() {
        this.stopBannerAutoPlay();
        this.bannerInterval = setInterval(() => {
          this.nextBanner();
        }, 5000);
      },

      stopBannerAutoPlay() {
        if (this.bannerInterval) {
          clearInterval(this.bannerInterval);
          this.bannerInterval = null;
        }
      },

      // Sidebar functions
      renderCategorySidebar() {
        const content = document.getElementById('categorySidebarContent');
        content.innerHTML = this.categories.map(cat => `
          <div class="category-sidebar-item" onclick="app.showCategory('${cat.id}'); app.closeCategorySidebar();">
            <i class="fas ${cat.icon || 'fa-circle'}"></i>
            <span>${cat.name}</span>
          </div>
        `).join('');
      },

      openCategorySidebar() {
        document.getElementById('categorySidebar').classList.add('active');
        document.getElementById('sidebarOverlay').classList.add('active');
      },

      closeCategorySidebar() {
        document.getElementById('categorySidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
      },

      // Search functions
      toggleSearch() {
        const container = document.getElementById('searchContainer');
        const input = document.getElementById('searchInput');
        
        if (container.classList.contains('active')) {
          container.classList.remove('active');
          input.value = '';
        } else {
          container.classList.add('active');
          setTimeout(() => input.focus(), 400);
        }
      },

      performSearchFromInput() {
        const query = document.getElementById('searchInput').value;
        this.performSearch(query);
      },

      performSearch(query) {
        if (!query.trim()) return;
        
        const searchResults = this.products.filter(p => 
          p.name.toLowerCase().includes(query.toLowerCase()) ||
          p.description.toLowerCase().includes(query.toLowerCase()) ||
          p.category.toLowerCase().includes(query.toLowerCase())
        );
        
        this.stopBannerAutoPlay();
        
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.remove('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        
        document.getElementById('categoryBreadcrumb').textContent = `Search: "${query}"`;
        document.getElementById('categoryTitle').textContent = `Search Results`;
        document.getElementById('categorySubtitle').textContent = `Found ${searchResults.length} products`;
        
        const grid = document.getElementById('categoryProducts');
        grid.innerHTML = searchResults.map(p => this.renderProductCard(p)).join('');
        
        document.getElementById('pagination').innerHTML = '';
        
        const searchContainer = document.getElementById('searchContainer');
        searchContainer.classList.remove('active');
        document.getElementById('searchInput').value = '';
        
        window.scrollTo(0, 0);
      },

      setupSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.performSearch(searchInput.value);
          }
        });
      },

      // Slider functions
      renderCardSlider() {
        const slider = document.getElementById('categoriesSlider');
        slider.innerHTML = this.categories.map(cat => `
          <div class="slider-card">
            <div class="category-slider-card" onclick="app.showCategory('${cat.id}')">
              <img src="${cat.image}" alt="${cat.name}">
              <h3>${cat.name}</h3>
              <p>${cat.description}</p>
            </div>
          </div>
        `).join('');
      },

      renderProductSlider() {
        const slider = document.getElementById('productsSlider');
        const featured = this.products.slice(0, 6);
        
        slider.innerHTML = featured.map(p => {
          const isInWishlist = this.wishlist.some(item => item.id === p.id);
          
          return `
            <div class="slider-card">
              <div class="product-slider-card" onclick="app.showProductDetail('${p.id}')">
                <div class="product-img">
                  <img src="${p.images[0]}" alt="${p.name}">
                </div>
                <div class="product-slider-info">
                  <div>
                    <h3>${p.name}</h3>
                    <div class="price">₹${p.price.toLocaleString()}</div>
                  </div>
                  <div class="product-slider-actions">
                    <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" 
                            onclick="event.stopPropagation(); app.toggleWishlist('${p.id}')"
                            title="${isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist'}">
                      <i class="fas fa-heart"></i>
                    </button>
                    <button class="add-to-cart-icon" 
                            onclick="event.stopPropagation(); app.addToCart('${p.id}')"
                            title="Add to Cart">
                      <i class="fas fa-cart-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      },

      slideLeft(type) {
        const slider = document.getElementById(type === 'categories' ? 'categoriesSlider' : 'productsSlider');
        slider.scrollBy({ left: -360, behavior: 'smooth' });
      },

      slideRight(type) {
        const slider = document.getElementById(type === 'categories' ? 'categoriesSlider' : 'productsSlider');
        slider.scrollBy({ left: 360, behavior: 'smooth' });
      },

      // Product functions
      renderProductCard(product) {
        const isInWishlist = this.wishlist.some(item => item.id === product.id);
        
        return `
          <div class="product-card" onclick="app.showProductDetail('${product.id}')">
            <div class="product-img">
              <img src="${product.images[0]}" alt="${product.name}">
            </div>
            <div class="product-info">
              <h3>${product.name}</h3>
              <p>${product.description.substring(0, 50)}...</p>
              <div class="price">₹${product.price.toLocaleString()}</div>
            </div>
            <div class="product-actions">
              <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" 
                      onclick="event.stopPropagation(); app.toggleWishlist('${product.id}')"
                      title="${isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist'}">
                <i class="fas fa-heart"></i>
              </button>
              <button class="add-to-cart-icon" 
                      onclick="event.stopPropagation(); app.addToCart('${product.id}')"
                      title="Add to Cart">
                <i class="fas fa-cart-plus"></i>
              </button>
            </div>
          </div>
        `;
      },

      showProductDetail(productId) {
        const product = this.products.find(p => p.id === productId);
        if (!product) return;
        
        this.currentProduct = product;
        this.productQuantity = 1;
        
        this.stopBannerAutoPlay();
        
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.remove('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        
        const category = this.categories.find(c => c.id === product.category);
        document.getElementById('productCategoryBreadcrumb').textContent = category.name;
        document.getElementById('productNameBreadcrumb').textContent = product.name;
        
        document.getElementById('productDetailTitle').textContent = product.name;
        document.getElementById('productDetailPrice').textContent = `₹${product.price.toLocaleString()}`;
        document.getElementById('productDetailDescription').textContent = product.description;
        document.getElementById('productQuantity').textContent = this.productQuantity;
        
        const mainImage = document.getElementById('mainImage').querySelector('img');
        mainImage.src = product.images[0];
        mainImage.alt = product.name;
        
        const thumbnails = document.getElementById('thumbnails');
        thumbnails.innerHTML = product.images.map((img, idx) => `
          <div class="thumbnail ${idx === 0 ? 'active' : ''}" onclick="app.changeMainImage('${img}', ${idx})">
            <img src="${img}" alt="${product.name}">
          </div>
        `).join('');
        
        const wishlistBtn = document.getElementById('productDetailWishlist');
        const isInWishlist = this.wishlist.some(item => item.id === product.id);
        wishlistBtn.classList.toggle('active', isInWishlist);
        wishlistBtn.setAttribute('title', isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist');
        
        window.scrollTo(0, 0);
      },

      changeMainImage(imageSrc, index) {
        const mainImage = document.getElementById('mainImage').querySelector('img');
        mainImage.src = imageSrc;
        
        document.querySelectorAll('.thumbnail').forEach((thumb, idx) => {
          thumb.classList.toggle('active', idx === index);
        });
      },

      increaseQuantity() {
        this.productQuantity++;
        document.getElementById('productQuantity').textContent = this.productQuantity;
      },

      decreaseQuantity() {
        if (this.productQuantity > 1) {
          this.productQuantity--;
          document.getElementById('productQuantity').textContent = this.productQuantity;
        }
      },

      // Navigation functions
      showHome() {
        document.getElementById('homePage').classList.remove('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        this.startBannerAutoPlay();
        window.scrollTo(0, 0);
      },

      showCategory(categoryId) {
        this.currentCategory = categoryId;
        this.currentPage = 1;
        const category = this.categories.find(c => c.id === categoryId);
        
        this.stopBannerAutoPlay();
        
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.remove('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        
        document.getElementById('categoryBreadcrumb').textContent = category.name;
        document.getElementById('categoryTitle').textContent = category.name;
        document.getElementById('categorySubtitle').textContent = category.description;
        
        this.renderCategoryProducts();
        window.scrollTo(0, 0);
      },

      renderCategoryProducts() {
        const products = this.products.filter(p => p.category === this.currentCategory);
        const startIdx = (this.currentPage - 1) * this.itemsPerPage;
        const endIdx = startIdx + this.itemsPerPage;
        const pageProducts = products.slice(startIdx, endIdx);
        
        const grid = document.getElementById('categoryProducts');
        grid.innerHTML = pageProducts.map(p => this.renderProductCard(p)).join('');
        
        this.renderPagination(products.length);
      },

      renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / this.itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
          pagination.innerHTML = '';
          return;
        }
        
        let html = `
          <button ${this.currentPage === 1 ? 'disabled' : ''} onclick="app.changePage(${this.currentPage - 1})">Previous</button>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
          html += `<button class="${i === this.currentPage ? 'active' : ''}" onclick="app.changePage(${i})">${i}</button>`;
        }
        
        html += `
          <button ${this.currentPage === totalPages ? 'disabled' : ''} onclick="app.changePage(${this.currentPage + 1})">Next</button>
        `;
        
        pagination.innerHTML = html;
      },

      changePage(page) {
        this.currentPage = page;
        this.renderCategoryProducts();
        window.scrollTo(0, 0);
      },

      showPolicy() {
        this.stopBannerAutoPlay();
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.remove('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        window.scrollTo(0, 0);
      },

      showCareGuide() {
        this.stopBannerAutoPlay();
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.remove('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        window.scrollTo(0, 0);
      },

      showWishlist() {
        this.stopBannerAutoPlay();
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.remove('hidden');
        
        this.renderWishlist();
        window.scrollTo(0, 0);
      },

      renderWishlist() {
        const container = document.getElementById('wishlistProducts');
        
        if (this.wishlist.length === 0) {
          container.innerHTML = '<div class="empty-cart">Your wishlist is empty</div>';
          return;
        }
        
        const wishlistProductsData = this.wishlist.map(wItem => {
          return this.products.find(p => p.id === wItem.id);
        }).filter(p => p);
        
        container.innerHTML = wishlistProductsData.map(p => this.renderProductCard(p)).join('');
      },

      // Wishlist functions
      toggleWishlistFromDetail() {
        if (!this.currentProduct) return;
        
        this.toggleWishlist(this.currentProduct.id);
        
        const button = document.getElementById('productDetailWishlist');
        const isInWishlist = this.wishlist.some(item => item.id === this.currentProduct.id);
        button.classList.toggle('active', isInWishlist);
        button.setAttribute('title', isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist');
      },
      
      toggleWishlist(productId) {
        const product = this.products.find(p => p.id === productId);
        if (!product) return;
        
        const existingIndex = this.wishlist.findIndex(item => item.id === productId);
        
        if (existingIndex !== -1) {
          this.wishlist.splice(existingIndex, 1);
          this.showWishlistNotification('Removed from wishlist');
        } else {
          this.wishlist.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.images[0]
          });
          this.showWishlistNotification('Added to wishlist!');
        }
        
        this.saveWishlist();
        this.updateWishlistCount();
        
        const buttons = document.querySelectorAll(`[onclick*="toggleWishlist('${productId}')"]`);
        buttons.forEach(button => {
          const isInWishlist = this.wishlist.some(item => item.id === productId);
          button.classList.toggle('active', isInWishlist);
          button.setAttribute('title', isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist');
        });
      },

      showWishlistNotification(message) {
        const notification = document.getElementById('wishlistNotification');
        document.getElementById('wishlistNotificationText').textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
        }, 2000);
      },
      
      saveWishlist() {
        localStorage.setItem('wishlist', JSON.stringify(this.wishlist));
      },

      updateWishlistCount() {
        const count = this.wishlist.length;
        const countEl = document.getElementById('wishlistCount');
        
        if (countEl) countEl.textContent = count;
      },

      // Cart functions - FIXED VERSION
      addToCart(productId, quantity = 1) {
        const product = this.products.find(p => p.id === productId);
        if (!product) return;
        
        const existingItem = this.cart.find(item => item.id === productId);
        
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          this.cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.images[0],
            quantity: quantity
          });
        }
        
        this.saveCart();
        this.updateCartCount();
        this.showCartNotification();
      },

      addToCartFromDetail() {
        if (!this.currentProduct) return;
        this.addToCart(this.currentProduct.id, this.productQuantity);
      },

      showCartNotification() {
        const notification = document.getElementById('cartNotification');
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
        }, 2000);
      },

      saveCart() {
        localStorage.setItem('cart', JSON.stringify(this.cart));
      },

      updateCartCount() {
        const count = this.cart.reduce((sum, item) => sum + item.quantity, 0);
        const countEl = document.getElementById('cartCount');
        
        if (countEl) countEl.textContent = count;
      },

      toggleCart() {
        const sidebar = document.getElementById('cartSidebar');
        sidebar.classList.toggle('active');
        
        if (sidebar.classList.contains('active')) {
          this.renderCart();
        }
      },

      renderCart() {
        const itemsContainer = document.getElementById('cartItems');
        const footerContainer = document.getElementById('cartFooter');
        
        if (this.cart.length === 0) {
          itemsContainer.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
          footerContainer.innerHTML = '';
          return;
        }
        
        itemsContainer.innerHTML = this.cart.map(item => `
          <div class="cart-item">
            <img src="${item.image}" alt="${item.name}">
            <div class="cart-item-info">
              <h4>${item.name}</h4>
              <div class="cart-item-price">₹${item.price.toLocaleString()}</div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="app.updateCartQuantity('${item.id}', -1)">−</button>
                <span>${item.quantity}</span>
                <button class="quantity-btn" onclick="app.updateCartQuantity('${item.id}', 1)">+</button>
              </div>
            </div>
            <button class="remove-item" onclick="app.removeFromCart('${item.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `).join('');
        
        const total = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        footerContainer.innerHTML = `
          <div class="cart-total">
            <span>Total:</span>
            <span>₹${total.toLocaleString()}</span>
          </div>
          <button class="checkout-btn" onclick="app.proceedToCheckout()">Proceed to Checkout</button>
        `;
      },

      updateCartQuantity(productId, change) {
        const item = this.cart.find(i => i.id === productId);
        if (!item) return;
        
        item.quantity += change;
        
        if (item.quantity <= 0) {
          this.removeFromCart(productId);
        } else {
          this.saveCart();
          this.updateCartCount();
          this.renderCart();
        }
      },

      removeFromCart(productId) {
        this.cart = this.cart.filter(item => item.id !== productId);
        this.saveCart();
        this.updateCartCount();
        this.renderCart();
      },

      // CHECKOUT FUNCTIONS - FIXED
      proceedToCheckout() {
        if (this.cart.length === 0) {
          alert('Your cart is empty!');
          return;
        }
        
        // Close cart sidebar
        const sidebar = document.getElementById('cartSidebar');
        sidebar.classList.remove('active');
        
        this.stopBannerAutoPlay();
        
        // Hide all pages
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.add('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        
        // Show checkout page
        document.getElementById('checkoutPage').classList.remove('hidden');
        
        // Render checkout
        this.renderCheckout();
        window.scrollTo(0, 0);
      },

      renderCheckout() {
        const itemsContainer = document.getElementById('checkoutItems');
        
        itemsContainer.innerHTML = this.cart.map(item => `
          <div class="summary-item">
            <span>${item.name} x ${item.quantity}</span>
            <span>₹${(item.price * item.quantity).toLocaleString()}</span>
          </div>
        `).join('');
        
        const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal >= 2000 ? 0 : 150;
        const total = subtotal + shipping;
        
        document.getElementById('checkoutSubtotal').textContent = `₹${subtotal.toLocaleString()}`;
        document.getElementById('checkoutShipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
        document.getElementById('checkoutTotal').textContent = `₹${total.toLocaleString()}`;
      },

      async submitCustomerForm() {
        const name = document.getElementById('customerName').value.trim();
        const email = document.getElementById('customerEmail').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const address = document.getElementById('customerAddress').value.trim();
        const pincode = document.getElementById('customerPincode').value.trim();
        const city = document.getElementById('customerCity').value.trim();
        const district = document.getElementById('customerDistrict').value.trim();
        const state = document.getElementById('customerState').value.trim();
        
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        document.querySelectorAll('.form-group input, .form-group textarea').forEach(el => el.classList.remove('error'));
        
        let hasError = false;
        
        if (!name) {
          document.getElementById('nameError').textContent = 'Please enter your name';
          document.getElementById('customerName').classList.add('error');
          hasError = true;
        }
        
        if (!email || !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
          document.getElementById('emailError').textContent = 'Please enter a valid email';
          document.getElementById('customerEmail').classList.add('error');
          hasError = true;
        }
        
        if (!phone || !phone.match(/^[\d\s\+\-\(\)]{10,15}$/)) {
          document.getElementById('phoneError').textContent = 'Please enter a valid phone number';
          document.getElementById('customerPhone').classList.add('error');
          hasError = true;
        }
        
        if (!pincode || !pincode.match(/^\d{6}$/)) {
          document.getElementById('pincodeError').textContent = 'Please enter a valid 6-digit PIN code';
          document.getElementById('customerPincode').classList.add('error');
          hasError = true;
        }
        
        if (!city) {
          document.getElementById('cityError').textContent = 'Please enter your city';
          document.getElementById('customerCity').classList.add('error');
          hasError = true;
        }
        
        if (!state) {
          document.getElementById('stateError').textContent = 'Please enter your state';
          document.getElementById('customerState').classList.add('error');
          hasError = true;
        }
        
        if (!address) {
          document.getElementById('addressError').textContent = 'Please enter your complete address';
          document.getElementById('customerAddress').classList.add('error');
          hasError = true;
        }
        
        if (hasError) return;
        
        this.customerInfo = { name, email, phone, address, pincode, city, district, state };
        this.initiatePayment();
      },

      closeCustomerForm() {
        this.showHome();
      },

      async initiatePayment() {
        const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal >= 2000 ? 0 : 150;
        const total = subtotal + shipping;
        
        const options = {
          key: CONFIG.razorpay.key,
          amount: total * 100,
          currency: 'INR',
          name: 'Misha Jewellery',
          description: 'Purchase of handcrafted silver jewelry',
          image: 'https://res.cloudinary.com/dsm5crlf1/image/upload/v1763133630/Maisha_Jewellery_Logo_2_ph7wqa.png',
          handler: async (response) => {
            await this.handlePaymentSuccess(response);
          },
          prefill: {
            name: this.customerInfo.name,
            email: this.customerInfo.email,
            contact: this.customerInfo.phone
          },
          theme: {
            color: '#1c214c'
          }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
      },

      async handlePaymentSuccess(paymentResponse) {
        const orderId = 'ORD' + Date.now();
        const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal >= 2000 ? 0 : 150;
        const total = subtotal + shipping;
        
        const orderData = {
          orderId,
          customer: this.customerInfo,
          items: this.cart,
          subtotal,
          shipping,
          total,
          paymentId: paymentResponse.razorpay_payment_id,
          timestamp: new Date().toISOString()
        };
        
        try {
          const { data, error } = await supabase
            .from('orders')
            .insert([orderData]);
          
          if (error) {
            console.error('Error saving order:', error);
          }
        } catch (err) {
          console.error('Failed to save order:', err);
        }
        
        await this.sendOrderEmails(orderData);
        
        this.cart = [];
        this.saveCart();
        this.updateCartCount();
        
        this.showOrderConfirmation(orderData);
      },

      async sendOrderEmails(orderData) {
        try {
          await fetch(CONFIG.supabase.emailFunctionUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${CONFIG.supabase.key}`
            },
            body: JSON.stringify({
              type: 'order_confirmation',
              orderData
            })
          });
        } catch (err) {
          console.error('Failed to send emails:', err);
        }
      },

      showOrderConfirmation(orderData) {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('categoryPage').classList.add('hidden');
        document.getElementById('productDetailPage').classList.add('hidden');
        document.getElementById('orderConfirmationPage').classList.remove('hidden');
        document.getElementById('policyPage').classList.add('hidden');
        document.getElementById('careGuidePage').classList.add('hidden');
        document.getElementById('checkoutPage').classList.add('hidden');
        document.getElementById('wishlistPage').classList.add('hidden');
        
        const detailsContent = document.getElementById('orderDetailsContent');
        detailsContent.innerHTML = `
          <p><strong>Order ID:</strong> ${orderData.orderId}</p>
          <p><strong>Payment ID:</strong> ${orderData.paymentId}</p>
          <p><strong>Total Amount:</strong> ₹${orderData.total.toLocaleString()}</p>
          <p><strong>Delivery Address:</strong><br>
            ${orderData.customer.name}<br>
            ${orderData.customer.address}<br>
            ${orderData.customer.city}, ${orderData.customer.state} - ${orderData.customer.pincode}<br>
            Phone: ${orderData.customer.phone}
          </p>
          <p><strong>Items:</strong></p>
          <ul style="list-style: none; padding: 0;">
            ${orderData.items.map(item => `
              <li style="margin: 0.5rem 0;">
                ${item.name} x ${item.quantity} - ₹${(item.price * item.quantity).toLocaleString()}
              </li>
            `).join('')}
          </ul>
        `;
        
        window.scrollTo(0, 0);
      },

      // Setup functions
      setupEventListeners() {
        document.getElementById('cartIcon').addEventListener('click', () => this.toggleCart());
        document.getElementById('closeCart').addEventListener('click', () => this.toggleCart());
        
        document.getElementById('customerPincode').addEventListener('input', async (e) => {
          const pincode = e.target.value;
          if (pincode.length === 6) {
            await this.fetchPincodeData(pincode);
          }
        });
      },

      async fetchPincodeData(pincode) {
        try {
          const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
          const data = await response.json();
          
          if (data[0].Status === 'Success' && data[0].PostOffice.length > 0) {
            const postOffice = data[0].PostOffice[0];
            document.getElementById('customerCity').value = postOffice.District;
            document.getElementById('customerDistrict').value = postOffice.Division;
            document.getElementById('customerState').value = postOffice.State;
          }
        } catch (err) {
          console.error('Failed to fetch pincode data:', err);
        }
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
